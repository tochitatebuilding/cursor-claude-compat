name: Issue Automation

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  respond-to-issue:
    name: Auto-respond to Issues
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'edited'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up rate limit script
        run: |
          chmod +x .github/scripts/rate-limit.sh
      
      - name: Get current date
        id: date
        run: |
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "hour=$(date -u +%Y-%m-%d-%H)" >> $GITHUB_OUTPUT
      
      - name: Restore rate limit cache
        uses: actions/cache@v4
        id: cache-rate-limit
        with:
          path: /tmp/rate-limit-cache
          key: rate-limit-${{ github.repository }}-${{ steps.date.outputs.date }}
          restore-keys: |
            rate-limit-${{ github.repository }}-
      
      - name: Check daily rate limit
        id: check_daily
        env:
          CACHE_DIR: /tmp/rate-limit-cache
          DAILY_LIMIT: 10
        run: |
          if ! .github/scripts/rate-limit.sh check daily; then
            echo "Daily rate limit reached. Skipping automation."
            echo "limit_reached=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "limit_reached=false" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check hourly rate limit
        id: check_hourly
        if: steps.check_daily.outputs.limit_reached == 'false'
        env:
          CACHE_DIR: /tmp/rate-limit-cache
          HOURLY_LIMIT: 3
        run: |
          if ! .github/scripts/rate-limit.sh check hourly; then
            echo "Hourly rate limit reached. Skipping automation."
            echo "limit_reached=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "limit_reached=false" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check issue-specific limit
        id: check_issue
        if: steps.check_hourly.outputs.limit_reached == 'false'
        env:
          CACHE_DIR: /tmp/rate-limit-cache
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_LIMIT: 1
        run: |
          if ! .github/scripts/rate-limit.sh check issue; then
            echo "Issue already responded. Skipping automation."
            echo "limit_reached=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "limit_reached=false" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Generate response
        id: generate_response
        if: steps.check_issue.outputs.limit_reached == 'false'
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          # Simple template-based response (no AI API for Phase 2)
          # This can be enhanced later with AI API integration
          
          RESPONSE="Thank you for opening this issue, @${{ github.event.issue.user.login }}!
          
          We've received your issue and will review it soon. 
          
          **Note**: This is an automated response. A maintainer will review your issue and respond accordingly.
          
          ---
          
          *This response was automatically generated by the issue automation system.*"
          
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post response to issue
        if: steps.generate_response.outputs.response != '' && steps.check_issue.outputs.limit_reached == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const response = `${{ steps.generate_response.outputs.response }}`;
            
            github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });
      
      - name: Increment rate limits
        if: steps.generate_response.outputs.response != '' && steps.check_issue.outputs.limit_reached == 'false'
        env:
          CACHE_DIR: /tmp/rate-limit-cache
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          .github/scripts/rate-limit.sh increment daily || true
          .github/scripts/rate-limit.sh increment hourly || true
          .github/scripts/rate-limit.sh increment issue || true
      
      - name: Save rate limit cache
        if: steps.generate_response.outputs.response != '' && steps.check_issue.outputs.limit_reached == 'false'
        uses: actions/cache@v4
        with:
          path: /tmp/rate-limit-cache
          key: rate-limit-${{ github.repository }}-${{ steps.date.outputs.date }}
          restore-keys: |
            rate-limit-${{ github.repository }}-
      
      - name: Add labels
        if: steps.check_issue.outputs.limit_reached == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const labels = ['automated-response'];
            
            // Add label if not already present
            github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
